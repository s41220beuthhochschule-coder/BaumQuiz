<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Baumarten Quiz ‚Äî Komplett</title>
<style>
:root{
  --bg:#fbfff9; --card:#fff; --muted:#2f4f2f; --accent:#66c188; --accent2:#8fd3b7;
  --danger:#dc2626; --success:#16a34a; --shadow:0 8px 24px rgba(11,22,10,0.06);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#123}
.app{max-width:1100px;margin:0 auto;padding:18px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-weight:700;font-size:20px;color:var(--muted)}
.lang-toggle{display:flex;gap:8px;align-items:center}

/* layout */
.levels{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:16px}
.level-card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px}
.level-title{font-weight:700;color:var(--muted);text-align:center}
.level-sub{font-size:13px;color:#6b7f63}
.level-foot{display:flex;align-items:center;gap:8px}

/* categories */
.cat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
.cat-card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04);display:flex;flex-direction:column;align-items:center;gap:6px}
.cat-title{font-weight:700;color:var(--muted)}
.cat-meta{font-size:13px;color:#6b7f63}

/* game */
.game{margin-top:12px;background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--shadow)}
.qhead{display:flex;justify-content:space-between;align-items:center}
.progress{height:8px;background:#eaf6ee;border-radius:8px;margin:10px 0;overflow:hidden}
.progress > span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .4s}
.main-img{max-width:520px;width:92%;height:auto;border-radius:12px;margin:12px auto;display:block;box-shadow:0 6px 16px rgba(0,0,0,0.06)}
.name-prompt{text-align:center;font-weight:700;margin-top:6px}
.answers{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.btn{padding:12px;border-radius:10px;border:1px solid #e6efe6;background:#fff;cursor:pointer;font-weight:700}
.btn.correct{background:#ecfdf5;border-color:var(--success);color:var(--success)}
.btn.wrong{background:#fff1f2;border-color:var(--danger);color:var(--danger)}
.anagram-area{display:flex;flex-direction:column;align-items:center;gap:8px;margin-top:12px}
.anagram-target{display:flex;gap:8px;flex-wrap:wrap;min-height:44px;padding:8px;border:1px dashed #e6efe6;border-radius:8px;background:#fff}
.anagram-letters{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
.letter{padding:8px 12px;border-radius:8px;border:1px solid #e6efe6;background:#fff;cursor:pointer;font-weight:700}
.nav{display:flex;gap:8px;justify-content:center;margin-top:12px}
.meta{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:#6b7f63;font-size:13px}

/* hearts */
.hearts{display:flex;gap:6px;align-items:center}
.heart{width:26px;height:26px;border-radius:6px;background:#ffd6d6;display:inline-flex;align-items:center;justify-content:center;color:#fff}
.heart.alive{background:linear-gradient(90deg,#ff6b6b,#ff3b3b)}
.loader{padding:12px;text-align:center;color:#6b7f63}
.game-over{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:9999}
.go-card{background:#fff;padding:18px;border-radius:12px;text-align:center;box-shadow:var(--shadow)}
.small{font-size:13px;color:#6b7f63}
@media (max-width:520px){
  .answers{grid-template-columns:1fr}
  .levels{grid-template-columns:1fr}
  .cat-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title" id="appTitle">üå≥ Baumarten Quiz ‚Äî Fertig</div>
    <div class="lang-toggle" id="langToggle"></div>
  </div>

  <!-- language modal -->
  <div id="langModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.28);z-index:999">
    <div style="background:#fff;padding:18px;border-radius:12px;max-width:420px;text-align:center">
      <h3 id="langTitle">W√§hle Sprache / Choose language</h3>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button id="chooseDe" style="padding:10px 12px;background:#e6f7ea;border-radius:8px;border:none;cursor:pointer">Deutsch</button>
        <button id="chooseEn" style="padding:10px 12px;background:#e6f0ff;border-radius:8px;border:none;cursor:pointer">English</button>
      </div>
    </div>
  </div>

  <!-- START -->
  <div id="startView">
    <div class="small" id="welcomeTitle" style="margin-top:12px"></div>
    <div class="small" id="welcomeSub"></div>
    <div id="levels" class="levels"></div>
    <div id="loader" class="loader" style="display:none">üåø Bilder werden gepr√ºft und geladen ...</div>
  </div>

  <!-- CATEGORIES -->
  <div id="categoriesView" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div id="levelHeading" style="font-weight:700"></div>
        <div id="levelSub" class="small"></div>
      </div>
      <div><button onclick="goHome()" style="background:none;border:none;cursor:pointer" id="backBtn">‚üµ</button></div>
    </div>
    <div class="cat-grid" id="catGrid"></div>
  </div>

  <!-- GAME -->
  <div id="gameView" style="display:none">
    <div class="game">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="qhead">
          <div id="qTitle" style="font-weight:700"></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="hearts" id="heartsArea"></div>
          <div id="langChangeBox"></div>
        </div>
      </div>

      <div class="progress"><span id="progressFill" style="width:0%"></span></div>

      <img id="mainImg" class="main-img" src="" alt="Baumbild" style="display:none"/>
      <div id="namePrompt" class="name-prompt"></div>

      <div id="answers" class="answers"></div>

      <div id="anagramWrapper" style="display:none">
        <div id="anagramTarget" class="anagram-target"></div>
        <div id="anagramLetters" class="anagram-letters"></div>
        <div style="text-align:center;margin-top:8px"><button onclick="resetAnagram()">Reset</button></div>
      </div>

      <div class="nav">
        <button id="prevBtn">‚óÄÔ∏è</button>
        <button id="nextBtn">‚ñ∂Ô∏è</button>
      </div>

      <div class="meta">
        <div id="progressText">Frage 0 / 0</div>
        <div id="scoreText">Punkte: 0</div>
      </div>

      <div id="timerBox" style="display:none;text-align:center;margin-top:8px">
        <div id="timerText" style="font-weight:700;font-size:18px">60</div>
      </div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="gameOver" class="game-over" style="display:none">
    <div class="go-card">
      <h3 id="goTitle">Spiel vorbei</h3>
      <p id="goText">Du hast keine Leben mehr.</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button onclick="retryLevel()">Erneut versuchen</button>
        <button onclick="goHome()">Zur Level-Auswahl</button>
      </div>
    </div>
  </div>

  <!-- END -->
  <div id="endView" style="display:none">
    <div style="text-align:center;margin-top:20px">
      <h2 id="endTitle">Ergebnis</h2>
      <p id="endSummary"></p>
      <div style="display:flex;gap:8px;justify-content:center">
        <button onclick="replay()">Nochmal</button>
        <button onclick="goToCategories()">Zur Kategorie</button>
        <button onclick="goHome()">Home</button>
      </div>
    </div>
  </div>

</div>

<script>
/* ---------------------------
  DATASET: ~30 reale Baumarten (kein "Baum n")
  - Wo m√∂glich: verifizierte Wikimedia-URLs f√ºr tree/leaf/fruit/bark/wood
  - Falls ein Bildtyp fehlt, bleibt das Feld null; die App versucht fallback/Commons-Suche
  --------------------------- */
const TREES = [
  { key:"Eiche", en:"Oak", scientific:"Quercus robur", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/6/6e/Stieleiche_Quercus_robur.jpg",
    leaf:"https://upload.wikimedia.org/wikipedia/commons/0/0c/Quercus_robur_leaf.jpg",
    fruit:"https://upload.wikimedia.org/wikipedia/commons/6/6e/Acorn_%28Quercus_robur%29.jpg",
    bark:"https://upload.wikimedia.org/wikipedia/commons/2/25/Quercus_robur_bark.jpg",
    wood:"https://upload.wikimedia.org/wikipedia/commons/4/4a/Quercus_robur_wood.jpg"
  }},
  { key:"Buche", en:"Beech", scientific:"Fagus sylvatica", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/f/fb/Fagus_sylvatica_001.JPG",
    leaf:"https://upload.wikimedia.org/wikipedia/commons/9/94/Fagus_sylvatica_leaf.jpg",
    fruit:"https://upload.wikimedia.org/wikipedia/commons/7/7f/Fagus_sylvatica_nuts.jpg",
    bark:"https://upload.wikimedia.org/wikipedia/commons/3/30/Fagus_sylvatica_bark.jpg",
    wood:null
  }},
  { key:"Fichte", en:"Spruce", scientific:"Picea abies", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/3/33/Picea_abies_Sommer.jpg",
    leaf:null,
    fruit:"https://upload.wikimedia.org/wikipedia/commons/1/1a/Picea_cones.jpg",
    bark:"https://upload.wikimedia.org/wikipedia/commons/1/1b/Picea_abies_bark.jpg",
    wood:null
  }},
  { key:"Kiefer", en:"Pine", scientific:"Pinus sylvestris", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/0/0a/Pinus_sylvestris_tree1.jpg",
    leaf:null,
    fruit:"https://upload.wikimedia.org/wikipedia/commons/6/61/Pinus_sylvestris_cones.jpg",
    bark:"https://upload.wikimedia.org/wikipedia/commons/7/70/Pinus_sylvestris_bark.jpg",
    wood:null
  }},
  { key:"Birke", en:"Birch", scientific:"Betula pendula", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/1/15/Betula_pendula_001.jpg",
    leaf:"https://upload.wikimedia.org/wikipedia/commons/2/23/Betula_pendula_leaves.jpg",
    fruit:null,
    bark:"https://upload.wikimedia.org/wikipedia/commons/a/ab/Betula_pendula_bark.jpg",
    wood:null
  }},
  { key:"Ahorn", en:"Maple", scientific:"Acer platanoides", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/d/de/Acer_platanoides_01.jpg",
    leaf:"https://upload.wikimedia.org/wikipedia/commons/1/17/Acer_platanoides_leaves.jpg",
    fruit:null,
    bark:"https://upload.wikimedia.org/wikipedia/commons/5/5b/Acer_platanoides_bark.jpg",
    wood:null
  }},
  { key:"Linde", en:"Linden", scientific:"Tilia cordata", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/a/ae/Tilia_cordata_001.jpg",
    leaf:"https://upload.wikimedia.org/wikipedia/commons/4/48/Tilia_cordata_leaf.jpg",
    fruit:null,
    bark:"https://upload.wikimedia.org/wikipedia/commons/6/6f/Tilia_bark.jpg",
    wood:null
  }},
  { key:"Esche", en:"Ash", scientific:"Fraxinus excelsior", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/a/aa/Fraxinus_excelsior.jpg",
    leaf:"https://upload.wikimedia.org/wikipedia/commons/3/38/Fraxinus_excelsior_leaves.jpg",
    fruit:null,
    bark:"https://upload.wikimedia.org/wikipedia/commons/6/64/Fraxinus_excelsior_bark.jpg",
    wood:null
  }},
  { key:"Tanne", en:"Fir", scientific:"Abies alba", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/e/e1/Abies_alba_001.jpg",
    leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"L√§rche", en:"Larch", scientific:"Larix decidua", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/8/86/Larix_decidua1.jpg",
    leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Ulme", en:"Elm", scientific:"Ulmus glabra", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/4/4a/Ulmus_glabra_Leaves_2008-08-11.jpg",
    leaf:"https://upload.wikimedia.org/wikipedia/commons/3/31/Ulmus_leaf.jpg",
    fruit:null, bark:null, wood:null
  }},
  { key:"Platane", en:"Plane", scientific:"Platanus √ó hispanica", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/4/47/Platanus_x_hispanica.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Kastanie", en:"Chestnut", scientific:"Castanea sativa", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/2/2d/Castanea_sativa_foliage_and_fruit.jpg",
    leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Eibe", en:"Yew", scientific:"Taxus baccata", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/0/02/Taxus_baccata_fruits_2005-10-25.jpg",
    leaf:null, fruit:"https://upload.wikimedia.org/wikipedia/commons/0/02/Taxus_baccata_fruits_2005-10-25.jpg", bark:null, wood:null
  }},
  { key:"Magnolie", en:"Magnolia", scientific:"Magnolia √ó soulangeana", continent:"Asia", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/9/93/Magnolia_x_soulangeana2.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Hainbuche", en:"Hornbeam", scientific:"Carpinus betulus", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/a/a2/Carpinus_betulus_leaf.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Robinie", en:"Black locust", scientific:"Robinia pseudoacacia", continent:"North America", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/7/70/Robinia_pseudoacacia_Bl%C3%BCte_2.JPG", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Erle", en:"Alder", scientific:"Alnus glutinosa", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/f/fc/Alnus_glutinosa01.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Weide", en:"Willow", scientific:"Salix alba", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/2/26/Salix_alba_tree.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Pappel", en:"Poplar", scientific:"Populus tremula", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/8/8e/Populus_tremula1.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Walnuss", en:"Walnut", scientific:"Juglans regia", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/5/52/Juglans_regia_foliage.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Kirschbaum", en:"Cherry", scientific:"Prunus avium", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/6/6b/Prunus_avium_2005.05.21_14.00.59.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Apfelbaum", en:"Apple", scientific:"Malus domestica", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/4/46/Malus_domestica_Bramley_apples.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Olive", en:"Olive", scientific:"Olea europaea", continent:"Europe", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/3/39/Olea_europaea_Tree.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Ginkgo", en:"Ginkgo", scientific:"Ginkgo biloba", continent:"Asia", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/6/6d/Ginkgo_biloba_001.JPG", leaf:"https://upload.wikimedia.org/wikipedia/commons/0/01/Ginkgo_leaf.jpg", fruit:null, bark:null, wood:null
  }},
  { key:"Mammutbaum", en:"Sequoia", scientific:"Sequoiadendron giganteum", continent:"North America", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/9/95/Sequoiadendron_giganteum_2.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Tulpenbaum", en:"Tulip tree", scientific:"Liriodendron tulipifera", continent:"North America", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/9/98/Liriodendron_tulipifera_%28bark%29.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Baobab", en:"Baobab", scientific:"Adansonia digitata", continent:"Africa", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/6/6d/Adansonia_digitata_02.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Jacaranda", en:"Jacaranda", scientific:"Jacaranda mimosifolia", continent:"South America", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/5/56/Jacaranda_mimosifolia_001.jpg", leaf:null, fruit:null, bark:null, wood:null
  }},
  { key:"Mango", en:"Mango", scientific:"Mangifera indica", continent:"Asia", imgs:{
    tree:"https://upload.wikimedia.org/wikipedia/commons/8/86/Mangifera_indica_tree.jpg", leaf:null, fruit:null, bark:null, wood:null
  }}
];

/* ---------------------------
  CONFIG & STATE
  --------------------------- */
const Q_PER_CAT = 25;
const TIME_SEC = 60;
let lang = localStorage.getItem('tree_lang') || null; // 'de'|'en'
let progress = JSON.parse(localStorage.getItem('tree_progress') || '{}');
let currentLevel = null;
let currentCategory = null;
let questions = [], indexQ = 0, score = 0, lives = 3;
let timerInterval = null, timeLeft = TIME_SEC, autoTimer = null;

/* UI refs */
const langModal = document.getElementById('langModal');
const chooseDe = document.getElementById('chooseDe');
const chooseEn = document.getElementById('chooseEn');
const levelsDiv = document.getElementById('levels');
const loader = document.getElementById('loader');
const startView = document.getElementById('startView');
const categoriesView = document.getElementById('categoriesView');
const catGrid = document.getElementById('catGrid');
const gameView = document.getElementById('gameView');
const answersEl = document.getElementById('answers');
const mainImg = document.getElementById('mainImg');
const namePrompt = document.getElementById('namePrompt');
const qTitle = document.getElementById('qTitle');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const scoreText = document.getElementById('scoreText');
const heartsArea = document.getElementById('heartsArea');
const anagramWrapper = document.getElementById('anagramWrapper');
const anagramTarget = document.getElementById('anagramTarget');
const anagramLetters = document.getElementById('anagramLetters');
const timerBox = document.getElementById('timerBox');
const timerText = document.getElementById('timerText');
const gameOverEl = document.getElementById('gameOver');

const TEXT = {
  de:{ welcome:'Willkommen', chooseLevel:'W√§hle ein Level', categories:'Kategorien', catA:'A ‚Äî 4 B√§ume', catB:'B ‚Äî Quiz (Einfach)', catC:'C ‚Äî Quiz (Schwer)', catD:'D ‚Äî Zeitmodus (60s)', catE:'E ‚Äî Blatt-Quiz', catF:'F ‚Äî Fr√ºchte-Quiz', catG:'G ‚Äî Rinden-Quiz', catH:'H ‚Äî Holzschnitt-Quiz', progress:'Fortschritt', record:'Rekord', question:'Frage', of:'von', score:'Punkte', next:'Weiter', prev:'Zur√ºck', timeleft:'Zeit', gameover:'Spiel vorbei', tryAgain:'Erneut versuchen', start:'Starten', home:'Home' },
  en:{ welcome:'Welcome', chooseLevel:'Choose a level', categories:'Categories', catA:'A ‚Äî 4 Trees', catB:'B ‚Äî Quiz (Easy)', catC:'C ‚Äî Quiz (Hard)', catD:'D ‚Äî Time Mode (60s)', catE:'E ‚Äî Leaf Quiz', catF:'F ‚Äî Fruit Quiz', catG:'G ‚Äî Bark Quiz', catH:'H ‚Äî Woodcut Quiz', progress:'Progress', record:'Record', question:'Question', of:'of', score:'Score', next:'Next', prev:'Prev', timeleft:'Time', gameover:'Game over', tryAgain:'Retry', start:'Start', home:'Home' }
};
function tr(k){ return (TEXT[lang] && TEXT[lang][k]) || TEXT['de'][k] || k; }

/* LEVELS */
const LEVELS = [
  { key:'level1', title_de:'Level 1 ‚Äî H√§ufige B√§ume', title_en:'Level 1 ‚Äî Common', filter: t=>true },
  { key:'all', title_de:'Alle B√§ume', title_en:'All trees', filter: t=>true },
  { key:'europe', title_de:'Europa', title_en:'Europe', filter: t=>t.continent==='Europe' },
  { key:'asia', title_de:'Asien', title_en:'Asia', filter: t=>t.continent==='Asia' },
  { key:'na', title_de:'Nordamerika', title_en:'North America', filter: t=>t.continent==='North America' },
  { key:'sa', title_de:'S√ºdamerika', title_en:'South America', filter: t=>t.continent==='South America' },
  { key:'africa', title_de:'Afrika', title_en:'Africa', filter: t=>t.continent==='Africa' }
];

/* ---------------------------
  INIT
  --------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  if(!lang){
    langModal.style.display='flex';
  } else {
    langModal.style.display='none';
    renderStart();
  }
  renderLangToggle();
});
chooseDe.addEventListener('click', ()=>{ setLang('de'); });
chooseEn.addEventListener('click', ()=>{ setLang('en'); });
function setLang(l){ lang = l; localStorage.setItem('tree_lang', l); langModal.style.display='none'; renderStart(); renderLangToggle(); }
function renderLangToggle(){ const box = document.getElementById('langToggle'); box.innerHTML=''; const btn = document.createElement('button'); btn.style.border='none'; btn.style.background='none'; btn.style.cursor='pointer'; btn.innerText = lang==='de' ? 'üá©üá™' : 'üá¨üáß'; btn.title = lang==='de' ? 'Sprache √§ndern' : 'Change language'; btn.onclick = ()=>{ langModal.style.display='flex'; }; box.appendChild(btn); }

/* render start / levels */
function renderStart(){
  document.getElementById('welcomeTitle').innerText = tr('welcome');
  document.getElementById('welcomeSub').innerText = tr('chooseLevel');
  renderLevelCards();
  startView.style.display='block';
  categoriesView.style.display='none';
  gameView.style.display='none';
  gameOverEl.style.display='none';
  document.getElementById('endView').style.display='none';
}

function renderLevelCards(){
  levelsDiv.innerHTML='';
  LEVELS.forEach(ld=>{
    const count = TREES.filter(ld.filter).length;
    const card = document.createElement('div'); card.className='level-card';
    const name = document.createElement('div'); name.className='level-title'; name.innerText = (lang==='de')?ld.title_de:ld.title_en;
    const sub = document.createElement('div'); sub.className='level-sub'; sub.innerText = `${count} ${tr('progress')}`;
    const foot = document.createElement('div'); foot.className='level-foot';
    const prog = getLevelCompletion(ld.key);
    const progText = document.createElement('div'); progText.className='small'; progText.innerText = `${prog.completed} / 4`;
    const star = document.createElement('div'); star.className='small'; star.innerHTML = prog.all ? '‚òÖ' : '‚òÜ';
    foot.appendChild(progText); foot.appendChild(star);
    card.appendChild(name); card.appendChild(sub); card.appendChild(foot);
    card.onclick = ()=>openCategories(ld.key);
    levelsDiv.appendChild(card);
  });
}

function getLevelCompletion(levelKey){
  const cats = ['A','B','C','D'];
  let completed = 0;
  cats.forEach(c=>{
    const key = progressKey(levelKey,c);
    const p = progress[key];
    if(p && p.completed) completed++;
  });
  return { completed: completed, all: completed === 4 };
}

/* ---------------------------
  Categories view
  --------------------------- */
function openCategories(levelKey){
  currentLevel = levelKey;
  startView.style.display='none';
  categoriesView.style.display='block';
  const ld = LEVELS.find(l=>l.key===levelKey);
  document.getElementById('levelHeading').innerText = (lang==='de')?ld.title_de:ld.title_en;
  document.getElementById('levelSub').innerText = `${TREES.filter(ld.filter).length} ${tr('progress')}`;
  renderCategories();
}

function renderCategories(){
  catGrid.innerHTML='';
  const cats = [
    { key:'A', title:tr('catA'), total: Q_PER_CAT },
    { key:'B', title:tr('catB'), total: Q_PER_CAT },
    { key:'C', title:tr('catC'), total: Q_PER_CAT },
    { key:'D', title:tr('catD'), total: TIME_SEC },
    { key:'E', title:tr('catE'), total: Q_PER_CAT },
    { key:'F', title:tr('catF'), total: Q_PER_CAT },
    { key:'G', title:tr('catG'), total: Q_PER_CAT },
    { key:'H', title:tr('catH'), total: Q_PER_CAT }
  ];
  cats.forEach(c=>{
    const card = document.createElement('div'); card.className='cat-card';
    const title = document.createElement('div'); title.className='cat-title'; title.innerText = c.title;
    const meta1 = document.createElement('div'); meta1.className='cat-meta';
    const meta2 = document.createElement('div'); meta2.className='cat-meta';
    const stored = progress[progressKey(currentLevel,c.key)];
    if(stored){ meta1.innerText = `${tr('progress')}: ${stored.correct||0} / ${c.total}`; meta2.innerText = `${tr('record')}: ${stored.best||0}`; } else { meta1.innerText = `${tr('progress')}: -`; meta2.innerText = `${tr('record')}: -`; }
    const btn = document.createElement('button'); btn.innerText = tr('start'); btn.onclick = ()=>startCategory(c.key);
    card.appendChild(title); card.appendChild(meta1); card.appendChild(meta2); card.appendChild(btn);
    catGrid.appendChild(card);
  });
}

/* ---------------------------
  Start category -> build pool
  --------------------------- */
function startCategory(catKey){
  currentCategory = catKey;
  const ld = LEVELS.find(l=>l.key===currentLevel);
  let pool = TREES.filter(ld.filter).map(t=>t.key);
  if(!pool.length) pool = TREES.map(t=>t.key);
  pool = shuffle(pool);
  if(catKey==='D'){ /* timed uses full pool */ }
  else pool = pool.slice(0, Math.min(Q_PER_CAT, pool.length));
  questions = pool.map(n=>({ name: n }));
  indexQ = 0; score = 0; lives = 3;
  updateHearts();
  categoriesView.style.display='none';
  startView.style.display='none';
  document.getElementById('endView').style.display='none';
  gameView.style.display='block';
  document.getElementById('timerBox').style.display = (catKey==='D') ? 'block' : 'none';
  if(catKey==='D'){ startTimer(); } else stopTimer();
  renderQuestion();
}

/* ---------------------------
  Render question (all categories)
  --------------------------- */
async function renderQuestion(){
  clearAuto();
  anagramWrapper.style.display='none';
  answersEl.innerHTML=''; mainImg.style.display='none'; namePrompt.innerText='';
  const cur = questions[indexQ];
  const name = cur.name;
  const total = questions.length;
  qTitle.innerText = `${tr('question')} ${indexQ+1} ${tr('of')} ${total}`;
  progressText.innerText = `${tr('question')} ${indexQ+1} / ${total}`;
  scoreText.innerText = `${tr('score')}: ${score}`;
  updateProgressBar();

  loader.style.display='block';
  if(currentCategory==='A'){
    const url = await getImageFor(name,'tree');
    if(url){ mainImg.src = url; mainImg.style.display='block'; } else mainImg.style.display='none';
    const opts = makeOptions(name,3);
    opts.forEach(opt=>{
      const b = document.createElement('div'); b.className='btn'; b.innerText = opt;
      b.onclick = ()=>handleAnswer(opt,name,b);
      answersEl.appendChild(b);
    });
  } else if(currentCategory==='B'){
    namePrompt.innerText = name;
    const opts = makeOptions(name,3);
    for(const opt of opts){
      const div = document.createElement('div'); div.className='btn';
      const img = document.createElement('img'); img.style.width='100%'; img.style.borderRadius='8px';
      div.appendChild(img); div.onclick = ()=>handleAnswer(opt,name,div);
      answersEl.appendChild(div);
      (async ()=>{
        const u = await getImageFor(opt,'tree');
        if(u) img.src = u; else div.innerText = opt;
      })();
    }
  } else if(currentCategory==='C'){
    const url = await getImageFor(name,'tree');
    if(url){ mainImg.src = url; mainImg.style.display='block'; } else mainImg.style.display='none';
    setupAnagram(name);
  } else if(currentCategory==='D'){
    const url = await getImageFor(name,'tree');
    if(url){ mainImg.src = url; mainImg.style.display='block'; } else mainImg.style.display='none';
    const opts = makeOptions(name,3);
    opts.forEach(opt=>{
      const b = document.createElement('div'); b.className='btn'; b.innerText = opt;
      b.onclick = ()=>handleAnswer(opt,name,b);
      answersEl.appendChild(b);
    });
  } else if(['E','F','G','H'].includes(currentCategory)){
    const type = currentCategory==='E' ? 'leaf' : (currentCategory==='F' ? 'fruit' : (currentCategory==='G' ? 'bark' : 'wood'));
    const url = await getImageFor(name,type);
    if(url){ mainImg.src = url; mainImg.style.display='block'; } else mainImg.style.display='none';
    const opts = makeOptions(name,3);
    opts.forEach(opt=>{
      const b = document.createElement('div'); b.className='btn'; b.innerText = opt;
      b.onclick = ()=>handleAnswer(opt,name,b);
      answersEl.appendChild(b);
    });
  }
  loader.style.display='none';

  document.getElementById('prevBtn').onclick = ()=>{ clearAuto(); if(indexQ>0){ indexQ--; renderQuestion(); } };
  document.getElementById('nextBtn').onclick = ()=>{ clearAuto(); if(currentCategory!=='D' && indexQ >= questions.length -1){ finishCategory(); } else { indexQ++; if(indexQ>=questions.length) indexQ = 0; renderQuestion(); } };
}

/* ---------------------------
  Make options (1 correct + n distractors)
  --------------------------- */
function makeOptions(correct, n){
  const all = TREES.map(t=>t.key).filter(k=>k!==correct);
  const shuffled = shuffle(all);
  const distract = shuffled.slice(0,n);
  return shuffle([correct, ...distract]);
}

/* ---------------------------
  Answer handling - lives & auto advance
  --------------------------- */
function handleAnswer(selected, correct, element){
  Array.from(answersEl.children).forEach(c=> c.onclick = null);
  if(selected === correct){
    element.classList.add('correct');
    score++;
    scoreText.innerText = `${tr('score')}: ${score}`;
    setTempProgress(currentLevel, currentCategory, score);
    autoTimer = setTimeout(()=> { clearAuto(); goNextAfterCorrect(); }, 900);
  } else {
    element.classList.add('wrong');
    Array.from(answersEl.children).forEach(c=>{ if(c.innerText && c.innerText.trim() === correct) c.classList.add('correct'); });
    lives--; updateHearts();
    if(lives <= 0){ showGameOver(); return; }
    setTempProgress(currentLevel, currentCategory, score);
  }
}

function goNextAfterCorrect(){
  if(currentCategory!=='D' && indexQ >= questions.length - 1){
    finishCategory();
  } else {
    indexQ++;
    if(currentCategory==='D' && indexQ >= questions.length) indexQ = 0;
    renderQuestion();
  }
}

/* ---------------------------
  Finish category
  --------------------------- */
function finishCategory(){
  stopTimer();
  saveCategoryResult(currentLevel, currentCategory, score, questions.length);
  document.getElementById('endView').style.display='block';
  document.getElementById('gameView').style.display='none';
  document.getElementById('endSummary').innerText = (lang==='de') ? `Du hast ${score} von ${questions.length} richtig beantwortet.` : `You answered ${score} of ${questions.length} correctly.`;
  renderStart();
}

/* ---------------------------
  Hearts / Game Over
  --------------------------- */
function updateHearts(){
  heartsArea.innerHTML='';
  for(let i=0;i<3;i++){
    const hb = document.createElement('div'); hb.className='heart';
    if(i < lives) hb.classList.add('alive');
    hb.innerText = i < lives ? '‚ù§' : '‚ô°';
    heartsArea.appendChild(hb);
  }
}

function showGameOver(){
  gameOverEl.style.display='flex';
  document.getElementById('goTitle').innerText = tr('gameover');
  document.getElementById('goText').innerText = (lang==='de') ? 'Du hast keine Leben mehr.' : 'You have no lives left.';
}

function retryLevel(){
  gameOverEl.style.display='none';
  startCategory(currentCategory);
}

/* ---------------------------
  Timer (D)
  --------------------------- */
function startTimer(){
  stopTimer();
  timeLeft = TIME_SEC;
  timerBox.style.display='block';
  timerText.innerText = timeLeft;
  timerInterval = setInterval(()=>{
    timeLeft--;
    timerText.innerText = timeLeft;
    if(timeLeft <= 0){
      stopTimer();
      finishCategory();
    }
  },1000);
}
function stopTimer(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
  timerBox.style.display='none';
}

/* ---------------------------
  Anagram (C)
  --------------------------- */
function setupAnagram(name){
  anagramWrapper.style.display='block';
  anagramTarget.innerHTML=''; anagramLetters.innerHTML='';
  const cleaned = name.replace(/[^\p{L}]/gu,'').toUpperCase();
  const letters = cleaned.split('');
  const alpha = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ√Ñ√ñ√ú';
  const extra = [];
  while(extra.length < Math.max(3, Math.floor(letters.length/1))) extra.push(alpha[Math.floor(Math.random()*alpha.length)]);
  const pool = shuffle(letters.concat(extra));
  for(let i=0;i<letters.length;i++){
    const s = document.createElement('div'); s.className='anagram-slot'; s.style.minWidth='34px'; s.style.minHeight='34px'; s.style.border='1px solid #e6efe6'; s.style.display='inline-flex'; s.style.alignItems='center'; s.style.justifyContent='center'; s.style.padding='6px'; s.style.margin='6px';
    anagramTarget.appendChild(s);
  }
  pool.forEach(ch=>{
    const b = document.createElement('div'); b.className='letter'; b.innerText = ch; b.onclick = ()=>placeLetter(b);
    anagramLetters.appendChild(b);
  });
  anagramTarget.dataset.answer = letters.join('');
}
function placeLetter(elem){
  const slots = Array.from(anagramTarget.children);
  const empty = slots.find(s=>!s.innerText);
  if(!empty) return;
  empty.innerText = elem.innerText;
  elem.style.visibility = 'hidden';
  if(slots.some(s=>!s.innerText)) return;
  const formed = slots.map(s=>s.innerText).join('');
  const ans = anagramTarget.dataset.answer;
  if(formed === ans){
    score++; scoreText.innerText = `${tr('score')}: ${score}`;
    setTempProgress(currentLevel, currentCategory, score);
    autoTimer = setTimeout(()=>{ clearAuto(); goNextAfterCorrect(); },900);
  } else {
    lives--; updateHearts();
    if(lives<=0){ showGameOver(); return; }
    slots.forEach(s=> s.style.borderColor='var(--danger)');
    setTimeout(()=> slots.forEach(s=> s.style.borderColor=''),600);
  }
}
function resetAnagram(){ Array.from(anagramLetters.children).forEach(c=> c.style.visibility='visible'); Array.from(anagramTarget.children).forEach(s=> s.innerText=''); }

/* ---------------------------
  Progress storage
  --------------------------- */
function setTempProgress(level, cat, correct){
  const key = progressKey(level,cat);
  if(!progress[key]) progress[key] = { correct:0, total:0, best:0, completed:false };
  progress[key].correct = correct;
  localStorage.setItem('tree_progress', JSON.stringify(progress));
  renderCategories();
}

function saveCategoryResult(level, cat, sc, total){
  const key = progressKey(level,cat);
  if(!progress[key]) progress[key] = { correct:0, total:0, best:0, completed:false };
  progress[key].last = sc;
  if(sc > (progress[key].best||0)) progress[key].best = sc;
  progress[key].correct = sc;
  progress[key].total = total || progress[key].total;
  if(cat==='A' && sc >= Q_PER_CAT) progress[key].completed = true;
  if(cat==='B' && sc >= Q_PER_CAT) progress[key].completed = true;
  if(cat==='C' && sc >= Q_PER_CAT) progress[key].completed = true;
  localStorage.setItem('tree_progress', JSON.stringify(progress));
  renderLevelCards();
}

/* ---------------------------
  Progress UI helpers
  --------------------------- */
function updateProgressBar(){
  const pct = Math.round(((indexQ) / Math.max(1, questions.length)) * 100);
  progressFill.style.width = pct + '%';
}

/* ---------------------------
  Utils
  --------------------------- */
function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
function clearAuto(){ if(autoTimer){ clearTimeout(autoTimer); autoTimer = null; } }
function progressKey(level,cat){ return `progress_${level}_${cat}`; }

/* ---------------------------
  Image retrieval: prefer dataset imgs, validate URLs, fallback to wiki commons search
  --------------------------- */
async function getImageFor(name, type){
  // find tree entry
  const t = TREES.find(x=> x.key === name);
  // type mapping
  const typeMap = { tree:'tree', leaf:'leaf', fruit:'fruit', bark:'bark', wood:'wood' };
  const reqType = typeMap[type] || 'tree';
  // try dataset specified URL first
  if(t && t.imgs && t.imgs[reqType]){
    if(await validateImageUrl(t.imgs[reqType])) return t.imgs[reqType];
  }
  // try other image types from dataset as fallback
  if(t && t.imgs){
    for(const k of ['tree','leaf','fruit','bark','wood']){
      if(t.imgs[k] && await validateImageUrl(t.imgs[k])) return t.imgs[k];
    }
  }
  // fallback to wiki (use scientific name if available)
  const qBase = (t && t.scientific) ? t.scientific : name;
  const wikiThumb = await searchWikiThumbnail(qBase + (reqType==='leaf' ? ' leaf' : reqType==='bark' ? ' bark' : ''));
  if(wikiThumb && await validateImageUrl(wikiThumb)) return wikiThumb;
  // final commons search generic
  const commons = await searchCommons(name + ' tree');
  if(commons && await validateImageUrl(commons)) return commons;
  return null;
}

function validateImageUrl(url){
  return new Promise((resolve)=>{
    if(!url) return resolve(false);
    const img = new Image();
    let done = false;
    img.onload = ()=>{ if(!done){ done=true; resolve(true); } };
    img.onerror = ()=>{ if(!done){ done=true; resolve(false); } };
    img.src = url;
    setTimeout(()=>{ if(!done){ done=true; resolve(false); } },3000);
  });
}

async function searchWikiThumbnail(q){
  try{
    const s = encodeURIComponent(q);
    const searchUrl = `https://de.wikipedia.org/w/rest.php/v1/search/page?q=${s}&limit=3`;
    const resp = await fetch(searchUrl);
    if(!resp.ok) return null;
    const j = await resp.json();
    if(j.pages && j.pages.length){
      for(const p of j.pages){
        try{
          const sumUrl = `https://de.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(p.key)}`;
          const sresp = await fetch(sumUrl);
          if(!sresp.ok) continue;
          const sjson = await sresp.json();
          if(sjson.thumbnail && sjson.thumbnail.source) return sjson.thumbnail.source;
          if(sjson.originalimage && sjson.originalimage.source) return sjson.originalimage.source;
        }catch(e){}
      }
    }
  }catch(e){}
  return null;
}

async function searchCommons(q){
  try{
    const s = encodeURIComponent(q);
    const commons = `https://commons.wikimedia.org/w/api.php?action=query&format=json&origin=*&prop=imageinfo&generator=search&gsrsearch=${s}&gsrlimit=3&iiprop=url`;
    const cr = await fetch(commons);
    if(!cr.ok) return null;
    const cj = await cr.json();
    if(cj.query && cj.query.pages){
      const pages = Object.values(cj.query.pages);
      for(const p of pages){
        if(p.imageinfo && p.imageinfo[0] && p.imageinfo[0].url) return p.imageinfo[0].url;
      }
    }
  }catch(e){}
  return null;
}

/* ---------------------------
  Init render
  --------------------------- */
renderLangToggle();
if(lang) renderStart();

function renderLangToggle(){
  const box = document.getElementById('langToggle');
  box.innerHTML='';
  const btn = document.createElement('button'); btn.style.border='none'; btn.style.background='none'; btn.style.cursor='pointer';
  btn.innerText = lang==='de' ? 'üá©üá™' : 'üá¨üáß';
  btn.title = lang==='de' ? 'Sprache √§ndern' : 'Change language';
  btn.onclick = ()=>{ document.getElementById('langModal').style.display='flex'; };
  box.appendChild(btn);
}

/* navigation helpers */
function replay(){ startCategory(currentCategory); }
function goToCategories(){ document.getElementById('endView').style.display='none'; document.getElementById('gameView').style.display='none'; categoriesView.style.display='block'; renderCategories(); }
function goHome(){ categoriesView.style.display='none'; document.getElementById('gameView').style.display='none'; document.getElementById('endView').style.display='none'; startView.style.display='block'; renderStart(); }

</script>
</body>
</html>
